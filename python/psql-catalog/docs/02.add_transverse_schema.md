# Transverse Schema

Resumo da Implementa√ß√£o

A funcionalidade de an√°lise de depend√™ncias de tabelas para o projeto psql-catalog foi implementada.
Abaixoi est√° um resumo completo do que foi criado:

üóÉÔ∏è Arquivos Criados

dependency_graph.py - Classe principal para an√°lise de depend√™ncias
batch_operations.py - Gera√ß√£o de comandos SQL em lote
test_dependency_graph.py - Testes automatizados completos
usage_example.py - Script de demonstra√ß√£o interativa
DEPENDENCY_ANALYSIS.md - Documenta√ß√£o completa
**init**.py (atualizado) - Exporta√ß√£o das novas classes

üéØ Funcionalidades Implementadas
TableDependencyGraph

‚úÖ An√°lise de foreign keys do JSON gerado pelo psql-catalog
‚úÖ Constru√ß√£o de grafo direcionado de depend√™ncias
‚úÖ Detec√ß√£o de depend√™ncias circulares (algoritmo DFS)
‚úÖ Ordena√ß√£o topol√≥gica (algoritmo de Kahn)
‚úÖ Suporte a auto-refer√™ncias (ex: categories.parent_id -> categories.id)
‚úÖ M√©todos para obter ordem de INSERT (depend√™ncias primeiro)
‚úÖ M√©todos para obter ordem de DROP (dependentes primeiro)
‚úÖ An√°lise detalhada de depend√™ncias por tabela

DatabaseBatchOperations

‚úÖ Gera√ß√£o de comandos DROP TABLE na ordem correta
‚úÖ Gera√ß√£o de comandos TRUNCATE na ordem correta
‚úÖ Gera√ß√£o de templates INSERT na ordem correta
‚úÖ Comandos para desabilitar/habilitar foreign keys
‚úÖ Salvamento de scripts SQL em arquivos
‚úÖ Suporte a op√ß√µes como CASCADE, RESTART IDENTITY
‚úÖ Execu√ß√£o opcional de comandos (com dry-run)

üîß Como Usar
Uso B√°sico
pythonfrom psql_catalog.dependency_graph import TableDependencyGraph
from psql_catalog.batch_operations import DatabaseBatchOperations

# 1. Analisar depend√™ncias

graph = TableDependencyGraph()
graph.load_from_json_file('my_schema.json')

# 2. Obter ordens corretas

insert_order = graph.get_insert_order() # Para INSERT seguro
drop_order = graph.get_drop_order() # Para DROP seguro

# 3. Gerar comandos SQL

batch_ops = DatabaseBatchOperations('my_schema.json')
drop_statements = batch_ops.generate_drop_statements(cascade=True)
Interface de Linha de Comando
bash# An√°lise completa
python -m psql_catalog.dependency_graph my_schema.json

# Gerar comandos espec√≠ficos

python -m psql_catalog.batch_operations drop my_schema.json --output drop.sql --cascade
python -m psql_catalog.batch_operations truncate my_schema.json --restart-identity  
python -m psql_catalog.batch_operations insert-template my_schema.json --output templates.sql

# Mostrar apenas as ordens

python -m psql_catalog.batch_operations order my_schema.json
Fun√ß√µes de Conveni√™ncia
pythonfrom psql_catalog.dependency_graph import get_table_insert_order, get_table_drop_order

# Uso r√°pido

insert_order = get_table_insert_order('my_schema.json')
drop_order = get_table_drop_order('my_schema.json')

üìã Casos de Uso Pr√°ticos

1. Preparar Ambiente de Teste
   python# Ordem completa para reset seguro:

# 1. Desabilitar FK constraints

# 2. TRUNCATE em ordem de dependentes

# 3. Reabilitar FK constraints

# 4. INSERT dados em ordem de depend√™ncias

2. Migra√ß√£o de Schema
   pythondrop_order = graph.get_drop_order() # order_items ‚Üí orders ‚Üí users
   create_order = graph.get_insert_order() # users ‚Üí orders ‚Üí order_items
3. Backup/Restore
   python# Mesmo ordem para ambos (depend√™ncias primeiro)
   backup_order = graph.get_insert_order() # users ‚Üí orders ‚Üí order_items
   ‚ö° Caracter√≠sticas T√©cnicas
   Algoritmos Utilizados

Detec√ß√£o de Ciclos: DFS (Depth-First Search) com pilha de recurs√£o
Ordena√ß√£o Topol√≥gica: Algoritmo de Kahn com fila de graus de entrada
Complexidade: O(V + E) onde V = tabelas, E = foreign keys

Tratamento de Casos Especiais

‚úÖ Auto-refer√™ncias: Detectadas e inclu√≠das na ordena√ß√£o
‚úÖ Depend√™ncias circulares: Detectadas com CycleDetectionError
‚úÖ Tabelas sem FK: Inclu√≠das com depend√™ncias vazias
‚úÖ Esquemas vazios: Tratamento gracioso de casos edge

üß™ Testes Implementados

‚úÖ Funcionalidade b√°sica: Carregamento e an√°lise de schema
‚úÖ Detec√ß√£o de ciclos: Teste com depend√™ncias circulares
‚úÖ Auto-refer√™ncias: Tabelas que referenciam a si mesmas
‚úÖ Opera√ß√µes em lote: Gera√ß√£o de todos os tipos de comando
‚úÖ Fun√ß√µes de conveni√™ncia: Testes das fun√ß√µes utilit√°rias
‚úÖ Casos extremos: Esquemas vazios, arquivos inv√°lidos
‚úÖ Valida√ß√£o: Verifica√ß√£o se as ordens respeitam depend√™ncias

üé® Demonstra√ß√£o Interativa
Execute python usage_example.py para ver:

An√°lise completa de um schema de exemplo
Gera√ß√£o de todos os tipos de comando SQL
Casos de uso pr√°ticos explicados
Salvamento de scripts SQL para an√°lise

üîç Exemplo de Sa√≠da
Para um schema com: users ‚Üê orders ‚Üê order_items e categories ‚Üê products:
INSERT order: users -> categories -> orders -> products -> order_items
DROP order: order_items -> products -> orders -> categories -> users

DROP statements:

1. DROP TABLE IF EXISTS order_items CASCADE;
2. DROP TABLE IF EXISTS products CASCADE;
3. DROP TABLE IF EXISTS orders CASCADE;
4. DROP TABLE IF EXISTS categories CASCADE;
5. DROP TABLE IF EXISTS users CASCADE;
   ‚ú® Principais Benef√≠cios

Seguran√ßa: Evita viola√ß√µes de foreign key constraints
Automa√ß√£o: Elimina necessidade de ordena√ß√£o manual
Flexibilidade: M√∫ltiplos tipos de opera√ß√£o suportados
Robustez: Detec√ß√£o de problemas (ciclos) antes da execu√ß√£o
Conveni√™ncia: Interface simples e fun√ß√µes utilit√°rias
Integra√ß√£o: Funciona perfeitamente com o JSON do psql-catalog
